<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Family Hub">
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="Track your family's goals, finances, and Madison's milestones on your journey to ¬£95k and your dream home">
  
  <title>Turnbull-Shaw Family Hub</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-16.png">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon-152.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon-144.png">
  
  <!-- Microsoft Tiles -->
  <meta name="msapplication-TileColor" content="#6366f1">
  <meta name="msapplication-TileImage" content="/icon-144.png">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    
    #root {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: white;
      text-align: center;
      padding: 20px;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      display: none;
      max-width: 90%;
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
    }
    
    .install-prompt.show {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
    
    .install-button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .install-button:hover {
      background: #4f46e5;
    }
    
    .close-button {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 4px;
      font-size: 20px;
      line-height: 1;
    }
    
    .update-prompt {
      position: fixed;
      top: 70px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .update-prompt.show {
      display: block;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="loading">
      <div class="loading-spinner"></div>
      <h1 style="font-size: 2em; margin-bottom: 10px;">‚ù§Ô∏è Family Hub</h1>
      <p>Loading your journey...</p>
    </div>
  </div>
  
  <!-- Install Prompt -->
  <div id="installPrompt" class="install-prompt">
    <div style="flex: 1;">
      <strong style="display: block; margin-bottom: 4px;">Install Family Hub</strong>
      <small style="color: #666;">Add to your home screen for quick access!</small>
    </div>
    <button id="installButton" class="install-button">Install</button>
    <button id="closePrompt" class="close-button">√ó</button>
  </div>
  
  <!-- Update Available Prompt -->
  <div id="updatePrompt" class="update-prompt">
    <strong>Update Available!</strong>
    <button onclick="window.location.reload()" style="background: white; color: #10b981; border: none; padding: 6px 12px; border-radius: 6px; margin-left: 12px; cursor: pointer; font-weight: 600;">
      Update Now
    </button>
  </div>
  
  <!-- React & Dependencies -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Recharts from CDNjs (only source that's allowed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>

  <!-- Library Check & Fallbacks -->
  <script>
    console.log('üì¶ Libraries loaded:');
    console.log('- React:', typeof React !== 'undefined' ? '‚úì' : '‚úó');
    console.log('- ReactDOM:', typeof ReactDOM !== 'undefined' ? '‚úì' : '‚úó');
    console.log('- Recharts:', typeof Recharts !== 'undefined' ? '‚úì' : '‚úó');
    console.log('- Lucide:', typeof lucide !== 'undefined' ? '‚úì' : '‚úó');
    
    // Create fallbacks if Recharts fails to load
    if (typeof Recharts === 'undefined') {
      console.warn('‚ö†Ô∏è Recharts failed to load, creating fallback placeholders');
      
      window.Recharts = {
        ResponsiveContainer: function({ children, width, height }) {
          return React.createElement('div', { 
            style: { 
              width: width || '100%', 
              height: height || 300, 
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              borderRadius: '16px', 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              color: 'white',
              fontSize: '18px',
              fontWeight: 'bold',
              padding: '20px',
              textAlign: 'center'
            }
          }, React.createElement('div', {}, 
            React.createElement('div', { style: { fontSize: '48px', marginBottom: '10px' }}, 'üìä'),
            React.createElement('div', {}, 'Chart View'),
            React.createElement('div', { style: { fontSize: '14px', marginTop: '10px', opacity: 0.8 }}, 
              'Charts will display here when data is available'
            )
          ));
        },
        LineChart: function() { return null; },
        Line: function() { return null; },
        AreaChart: function() { return null; },
        Area: function() { return null; },
        RadarChart: function() { return null; },
        Radar: function() { return null; },
        BarChart: function() { return null; },
        Bar: function() { return null; },
        PieChart: function() { return null; },
        Pie: function() { return null; },
        Cell: function() { return null; },
        XAxis: function() { return null; },
        YAxis: function() { return null; },
        CartesianGrid: function() { return null; },
        Tooltip: function() { return null; },
        Legend: function() { return null; },
        PolarGrid: function() { return null; },
        PolarAngleAxis: function() { return null; },
        PolarRadiusAxis: function() { return null; }
      };
    }
    
    // Ensure Lucide is available
    if (typeof lucide === 'undefined') {
      console.error('‚ùå Lucide icons failed to load');
    }
  </script>
  
  <!-- Service Worker & PWA Setup -->
  <script>
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('‚úì ServiceWorker registered:', registration);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  document.getElementById('updatePrompt').classList.add('show');
                }
              });
            });
          })
          .catch(err => {
            console.log('ServiceWorker registration failed:', err);
          });
      });
    }
    
    // PWA Install Prompt
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installButton = document.getElementById('installButton');
    const closePrompt = document.getElementById('closePrompt');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      setTimeout(() => {
        installPrompt.classList.add('show');
      }, 10000);
    });
    
    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to install prompt: ${outcome}`);
        deferredPrompt = null;
        installPrompt.classList.remove('show');
      }
    });
    
    closePrompt.addEventListener('click', () => {
      installPrompt.classList.remove('show');
    });
    
    window.addEventListener('appinstalled', () => {
      console.log('‚úì PWA installed successfully!');
      installPrompt.classList.remove('show');
    });
    
    // Storage API for persistent data
    window.storage = {
      async get(key) {
        try {
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        } catch (error) {
          console.error('Storage get error:', error);
          return null;
        }
      },
      async set(key, value) {
        try {
          localStorage.setItem(key, value);
          return true;
        } catch (error) {
          console.error('Storage set error:', error);
          return false;
        }
      },
      async remove(key) {
        try {
          localStorage.removeItem(key);
          return true;
        } catch (error) {
          console.error('Storage remove error:', error);
          return false;
        }
      }
    };
    
    // Request persistent storage
    if (navigator.storage && navigator.storage.persist) {
      navigator.storage.persist().then(granted => {
        if (granted) {
          console.log('‚úì Storage will not be cleared except by explicit user action');
        }
      });
    }
    
    // Handle URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const tab = urlParams.get('tab');
    const action = urlParams.get('action');
    
    window.initialState = { mode, tab, action };
  </script>
  
  <!-- Load Main App -->
  <script type="text/babel" src="/turnbull-shaw-pwa.jsx"></script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(TurnbullShawDashboard));
  </script>
  
  <!-- iOS Compatibility -->
  <script>
    // Check if running as standalone app
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                        window.navigator.standalone === true;
    
    if (isStandalone) {
      console.log('‚úì Running as installed PWA');
    }
    
    // Prevent zoom on double tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (event) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>
  
  <!-- Apple iOS specific meta tags -->
  <meta name="apple-mobile-web-app-title" content="Family Hub">
  <meta name="format-detection" content="telephone=no">
  
  <!-- Splash screens for iOS -->
  <link rel="apple-touch-startup-image" href="/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
</body>
</html>
